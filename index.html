<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Travel Internal Dashboard ‚Äì Prototype</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f4f5fb;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --primary-soft: #e0ebff;
      --border: #e2e8f0;
      --text-main: #111827;
      --text-muted: #6b7280;
      --danger: #dc2626;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.06);
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top left, #e0edff, #f9fafb 50%, #f3f4ff);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.02em;
    }

    header span {
      font-size: 13px;
      color: var(--text-muted);
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-weight: 500;
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.3);
      transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(37, 99, 235, 0.35);
      background: #1d4ed8;
    }

    .btn-secondary {
      background: #eff3ff;
      border-radius: 999px;
      padding: 8px 14px;
      border: 1px solid #d0ddff;
      font-size: 13px;
      color: #1f2937;
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: #e1e8ff;
    }

    .btn-link {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 12px;
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
    }

    .btn-link.danger {
      color: var(--danger);
    }

    .icon {
      font-size: 18px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .grid {
      display: grid;
      gap: 16px;
    }

    @media (min-width: 900px) {
      .grid-2 {
        grid-template-columns: 2fr 1.3fr;
      }
      .grid-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }

    .search-row {
      display: flex;
      gap: 12px;
      margin-bottom: 14px;
      flex-wrap: wrap;
    }

    .search-input-wrap {
      position: relative;
      flex: 1;
      min-width: 230px;
    }

    .search-input-wrap input {
      width: 100%;
      border-radius: 999px;
      padding: 9px 34px 9px 34px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
      background: #f9fafb;
    }

    .search-input-wrap input:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    .search-input-wrap .search-icon {
      position: absolute;
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
      color: var(--text-muted);
    }

    .search-input-wrap .search-hint {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: var(--text-muted);
    }

    .chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      background: #f9fafb;
      color: var(--text-muted);
    }

    .chip.active {
      background: var(--primary-soft);
      color: var(--primary);
      border-color: #c4d5ff;
    }

    .summary-value {
      font-size: 20px;
      font-weight: 650;
      margin: 8px 0 2px;
    }

    .summary-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-muted);
    }

    .summary-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th,
    td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: middle;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #f3f4ff;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .tag.small {
      font-size: 10px;
      padding: 1px 6px;
    }

    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }

    .rq-pill {
      font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #0f172a;
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .rq-pill span {
      font-size: 9px;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .empty-state {
      padding: 12px;
      text-align: center;
      font-size: 13px;
      color: var(--text-muted);
    }

    /* Modal */

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 50;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      background: #ffffff;
      max-width: 780px;
      width: 100%;
      border-radius: 18px;
      padding: 18px 20px 16px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      max-height: 90vh;
      overflow: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 17px;
    }

    .close-btn {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    .form-group {
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 4px;
      color: #4b5563;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
    }

    textarea {
      resize: vertical;
      min-height: 50px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
    }

    .service-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 6px 0;
      gap: 8px;
    }

    .service-row {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr 1.3fr 1fr 0.9fr auto;
      gap: 6px;
      margin-bottom: 6px;
      align-items: center;
    }

    .service-row textarea {
      grid-column: 1 / -2;
    }

    @media (max-width: 800px) {
      .service-row {
        grid-template-columns: 1fr 1fr;
      }
      .service-row textarea {
        grid-column: 1 / -1;
      }
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost:hover {
      background: #eef2ff;
      border-style: solid;
    }

    .pill-danger {
      font-size: 11px;
      color: var(--danger);
      cursor: pointer;
      background: #fee2e2;
      border-radius: 999px;
      padding: 2px 7px;
      border: 1px solid #fecaca;
      text-align: center;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .help-text {
      font-size: 11px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div>
        <h1>Travel Operation Dashboard</h1>
        <span>Prototype alur kerja berbasis RQ# (laporan perjalanan klien)</span>
      </div>
      <button class="btn-primary" id="btnOpenModal">
        <span class="icon">Ôºã</span>
        <span>Add Booking</span>
      </button>
    </header>

    <!-- SEARCH + FILTER -->
    <div class="card" style="margin-bottom:16px;">
      <div class="search-row">
        <div class="search-input-wrap">
          <span class="search-icon">üîç</span>
          <input
            id="searchInput"
            type="text"
            placeholder="Cari by RQ# atau nama tamu‚Ä¶ (misal: 011125 atau 'Ahmed')"
          />
          <span class="search-hint">Enter untuk cari</span>
        </div>
        <button class="btn-secondary" id="btnSearchToday">Order hari ini</button>
        <button class="btn-secondary" id="btnSearchThisMonth">Order bulan ini</button>
      </div>
      <div class="chip-group">
        <div class="chip active" data-service-filter="all">Semua service</div>
        <div class="chip" data-service-filter="Accommodation">Accommodation</div>
        <div class="chip" data-service-filter="Transportation">Transportation</div>
        <div class="chip" data-service-filter="Flight Ticket">Flight Ticket</div>
        <div class="chip" data-service-filter="Local Partner">Local Partner</div>
      </div>
    </div>

    <!-- SUMMARY + TODAY TABLE -->
    <div class="grid grid-2">
      <div class="card">
        <h3 style="margin:0 0 8px;font-size:14px;">Order service hari ini</h3>
        <div id="todayTableWrapper">
          <div class="empty-state">
            Belum ada data. Tambahkan booking dengan tombol <b>Add Booking</b>.
          </div>
        </div>
      </div>

      <div class="grid grid-4">
        <div class="card">
          <div class="summary-label">Pendapatan hari ini</div>
          <div class="summary-value" id="revenueToday">0</div>
          <div class="summary-sub">
            Dari semua service dengan tanggal layanan = hari ini.
          </div>
        </div>
        <div class="card">
          <div class="summary-label">Pendapatan bulan ini</div>
          <div class="summary-value" id="revenueMonth">0</div>
          <div class="summary-sub">Semua service di bulan berjalan.</div>
        </div>
        <div class="card">
          <div class="summary-label">Total booking</div>
          <div class="summary-value" id="totalBookings">0</div>
          <div class="summary-sub">Jumlah RQ# yang tercatat.</div>
        </div>
        <div class="card">
          <div class="summary-label">Service tercatat</div>
          <div class="summary-value" id="totalServices">0</div>
          <div class="summary-sub">Baris aktivitas (hotel, transport, dll).</div>
        </div>
      </div>
    </div>

    <!-- SEARCH RESULT -->
    <div class="card" style="margin-top:18px;">
      <h3 style="margin:0 0 8px;font-size:14px;">Hasil pencarian</h3>
      <div id="searchResultWrapper">
        <div class="empty-state">
          Ketik RQ# atau nama tamu di atas lalu tekan <b>Enter</b>.
        </div>
      </div>
    </div>

    <!-- ALL BOOKINGS / CRUD -->
    <div class="card" style="margin-top:18px;">
      <h3 style="margin:0 0 8px;font-size:14px;">Daftar booking (CRUD temporary)</h3>
      <div id="bookingListWrapper">
        <div class="empty-state">
          Belum ada booking. Gunakan tombol <b>Add Booking</b> untuk membuat data demo.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL ADD / EDIT BOOKING -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2 id="modalTitle">Buat Booking Baru</h2>
          <div class="help-text">
            RQ# otomatis: format <b>NNMMYY</b> (nomor urut di bulan, bulan, tahun).
          </div>
        </div>
        <button class="close-btn" id="btnCloseModal">&times;</button>
      </div>

      <form id="bookingForm">
        <div class="form-row">
          <div class="form-group">
            <label>RQ# (auto)</label>
            <div class="rq-pill">
              <span>RQ</span>
              <strong id="generatedRq">000000</strong>
            </div>
          </div>
          <div class="form-group">
            <label>Booking / Arrival date</label>
            <input type="date" id="bookingDate" required />
          </div>
        </div>

        <div class="form-group">
          <label>Nama tamu / booking name</label>
          <input
            type="text"
            id="guestName"
            required
            placeholder="Contoh: AHMED Dilwar Mr"
          />
        </div>

        <div class="service-list-header">
          <div>
            <label style="margin-bottom:2px;">Service yang dibeli</label>
            <div class="help-text">
              1 RQ# bisa berisi banyak service (accommodation, transportation, dll).
              Supplier name & locality hanya dari dummy data.
            </div>
          </div>
          <button type="button" class="btn-ghost" id="btnAddServiceRow">
            <span class="icon">Ôºã</span> Tambah service
          </button>
        </div>

        <div id="serviceRowsContainer"></div>

        <div class="modal-footer">
          <div class="help-text">
            Data disimpan di memori browser (temporary demo). Akan hilang jika tab
            di-refresh.
          </div>
          <div style="display:flex;gap:8px;">
            <button type="button" class="btn-secondary" id="btnCancelModal">
              Batal
            </button>
            <button type="submit" class="btn-primary">
              <span class="icon">üíæ</span> Simpan booking
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ====== DUMMY DATA SUPPLIER ======
    const SUPPLIER_DATA = {
      Accommodation: {
        Kuta: [
          "Ramayana Suites & Resort",
          "Kuta Paradiso Hotel",
          "Hard Rock Hotel"
        ],
        Sanur: ["Puri Santrian", "Maya Sanur", "Prama Sanur Beach"],
        Ubud: ["Alaya Resort Ubud", "Komaneka Bisma", "Element by Westin Ubud"]
      },
      Transportation: {
        Denpasar: [
          "Bali Pradana Transport (BPT)",
          "Bali Mita Driver",
          "Surya Transport"
        ],
        Jimbaran: ["Jimbaran Transport Service", "Bukit Shuttle"]
      },
      "Flight Ticket": {
        "Domestic Flight": ["Garuda Indonesia", "Lion Air", "Citilink"],
        "International Flight": [
          "Singapore Airlines",
          "Malaysia Airlines",
          "AirAsia"
        ]
      },
      "Local Partner": {
        "Pangkal Bun": ["Orang Utan Applause", "Borneo Eco Trip"],
        Surabaya: ["Kampi Hotel Tunjungan", "Surabaya Travel Club"]
      }
    };

    // ====== STATE SEMENTARA ======
    let bookings = []; // {id, rq, guestName, bookingDate, services:[...]}
    let bookingCounter = 1; // untuk NN di NNMMYY
    let editingBookingId = null;
    let activeServiceFilter = "all";

    const todayStr = new Date().toISOString().slice(0, 10);

    // ====== ELEMENT REFS ======
    const modalBackdrop = document.getElementById("modalBackdrop");
    const btnOpenModal = document.getElementById("btnOpenModal");
    const btnCloseModal = document.getElementById("btnCloseModal");
    const btnCancelModal = document.getElementById("btnCancelModal");
    const bookingForm = document.getElementById("bookingForm");
    const generatedRqSpan = document.getElementById("generatedRq");
    const bookingDateInput = document.getElementById("bookingDate");
    const guestNameInput = document.getElementById("guestName");
    const serviceRowsContainer = document.getElementById("serviceRowsContainer");
    const btnAddServiceRow = document.getElementById("btnAddServiceRow");
    const modalTitle = document.getElementById("modalTitle");

    const revenueTodayEl = document.getElementById("revenueToday");
    const revenueMonthEl = document.getElementById("revenueMonth");
    const totalBookingsEl = document.getElementById("totalBookings");
    const totalServicesEl = document.getElementById("totalServices");
    const todayTableWrapper = document.getElementById("todayTableWrapper");
    const searchInput = document.getElementById("searchInput");
    const searchResultWrapper = document.getElementById("searchResultWrapper");
    const btnSearchToday = document.getElementById("btnSearchToday");
    const btnSearchThisMonth = document.getElementById("btnSearchThisMonth");
    const chips = document.querySelectorAll(".chip");
    const bookingListWrapper = document.getElementById("bookingListWrapper");

    // ====== UTIL ======
    function formatCurrency(n) {
      return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0
      }).format(n || 0);
    }

    function generateRq() {
      const now = new Date();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const yy = String(now.getFullYear()).slice(-2);
      const nn = String(bookingCounter).padStart(2, "0");
      return `${nn}${mm}${yy}`; // NNMMYY
    }

    // ====== MODAL OPEN/CLOSE ======
    function openModal(booking) {
      bookingForm.reset();
      serviceRowsContainer.innerHTML = "";

      if (booking) {
        editingBookingId = booking.id;
        modalTitle.textContent = "Edit Booking";
        generatedRqSpan.textContent = booking.rq;
        bookingDateInput.value = booking.bookingDate;
        guestNameInput.value = booking.guestName;
        booking.services.forEach((s) => addServiceRow(s));
      } else {
        editingBookingId = null;
        modalTitle.textContent = "Buat Booking Baru";
        generatedRqSpan.textContent = generateRq();
        bookingDateInput.value = todayStr;
        addServiceRow();
      }
      modalBackdrop.classList.add("show");
    }

    function closeModal() {
      modalBackdrop.classList.remove("show");
    }

    // ====== SERVICE ROW (CASCADING SELECT) ======
    function addServiceRow(initial) {
      const row = document.createElement("div");
      row.className = "service-row";

      const typeSelect = document.createElement("select");
      typeSelect.className = "service-type";

      Object.keys(SUPPLIER_DATA).forEach((type) => {
        const opt = document.createElement("option");
        opt.value = type;
        opt.textContent = type;
        typeSelect.appendChild(opt);
      });

      const localitySelect = document.createElement("select");
      localitySelect.className = "service-locality";

      const supplierSelect = document.createElement("select");
      supplierSelect.className = "service-supplier";

      const dateInput = document.createElement("input");
      dateInput.type = "date";
      dateInput.className = "service-date";
      dateInput.value = initial?.date || todayStr;

      const priceInput = document.createElement("input");
      priceInput.type = "number";
      priceInput.min = "0";
      priceInput.placeholder = "Harga (IDR)";
      priceInput.className = "service-price";
      priceInput.value = initial?.price != null ? initial.price : "";

      const descInput = document.createElement("textarea");
      descInput.className = "service-desc";
      descInput.placeholder =
        "Contoh: Ramayana Suites & Resort, transfer bandara, dll";
      descInput.value = initial?.description || "";

      const removeBtn = document.createElement("div");
      removeBtn.className = "pill-danger";
      removeBtn.textContent = "hapus";

      // helper untuk isi locality dan supplier
      function populateLocalities(selectedType, selectedLoc, selectedSupplier) {
        const locs = Object.keys(SUPPLIER_DATA[selectedType] || {});
        localitySelect.innerHTML = "";
        locs.forEach((loc) => {
          const opt = document.createElement("option");
          opt.value = loc;
          opt.textContent = loc;
          localitySelect.appendChild(opt);
        });

        let locToUse =
          selectedLoc && locs.includes(selectedLoc) ? selectedLoc : locs[0];
        localitySelect.value = locToUse || "";

        populateSuppliers(selectedType, locToUse, selectedSupplier);
      }

      function populateSuppliers(type, loc, selectedSupplier) {
        const sups = (SUPPLIER_DATA[type] && SUPPLIER_DATA[type][loc]) || [];
        supplierSelect.innerHTML = "";
        sups.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          supplierSelect.appendChild(opt);
        });
        if (selectedSupplier && sups.includes(selectedSupplier)) {
          supplierSelect.value = selectedSupplier;
        }
      }

      // apply initial values
      if (initial?.type && SUPPLIER_DATA[initial.type]) {
        typeSelect.value = initial.type;
      }
      populateLocalities(
        typeSelect.value,
        initial?.locality,
        initial?.supplier
      );

      // listeners cascading
      typeSelect.addEventListener("change", () => {
        populateLocalities(typeSelect.value);
      });

      localitySelect.addEventListener("change", () => {
        populateSuppliers(typeSelect.value, localitySelect.value);
      });

      removeBtn.addEventListener("click", () => {
        if (serviceRowsContainer.children.length > 1) {
          row.remove();
        }
      });

      // susun row
      row.appendChild(typeSelect);
      row.appendChild(localitySelect);
      row.appendChild(supplierSelect);
      row.appendChild(dateInput);
      row.appendChild(priceInput);
      row.appendChild(removeBtn);
      serviceRowsContainer.appendChild(row);

      // desc full width di bawah
      const descWrapper = document.createElement("div");
      descWrapper.style.gridColumn = "1 / -1";
      descWrapper.appendChild(descInput);
      row.appendChild(descWrapper);
    }

    function collectServicesFromForm() {
      const rows = serviceRowsContainer.querySelectorAll(".service-row");
      const services = [];
      rows.forEach((row) => {
        const type = row.querySelector(".service-type").value;
        const locality = row.querySelector(".service-locality").value;
        const supplier = row.querySelector(".service-supplier").value;
        const date = row.querySelector(".service-date").value || todayStr;
        const price = Number(row.querySelector(".service-price").value || 0);
        const desc = row.querySelector(".service-desc").value.trim();
        services.push({ type, locality, supplier, date, price, description: desc });
      });
      return services;
    }

    // ====== RENDER DASHBOARD & LIST ======
    function renderDashboard() {
      let totalToday = 0;
      let totalMonth = 0;
      let totalServices = 0;
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();

      bookings.forEach((b) => {
        b.services.forEach((s) => {
          totalServices++;
          const d = new Date(s.date);
          if (!isNaN(d)) {
            if (s.date === todayStr) totalToday += s.price || 0;
            if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
              totalMonth += s.price || 0;
            }
          }
        });
      });

      revenueTodayEl.textContent = formatCurrency(totalToday);
      revenueMonthEl.textContent = formatCurrency(totalMonth);
      totalBookingsEl.textContent = bookings.length;
      totalServicesEl.textContent = totalServices;

      // table order hari ini
      const rows = [];
      bookings.forEach((b) => {
        b.services.forEach((s) => {
          if (s.date === todayStr) {
            if (activeServiceFilter === "all" || s.type === activeServiceFilter) {
              rows.push({
                rq: b.rq,
                guestName: b.guestName,
                type: s.type,
                locality: s.locality,
                supplier: s.supplier,
                desc: s.description,
                price: s.price,
                date: s.date
              });
            }
          }
        });
      });

      if (!rows.length) {
        todayTableWrapper.innerHTML =
          '<div class="empty-state">Belum ada service dengan tanggal hari ini untuk filter saat ini.</div>';
      } else {
        let html = `<div style="overflow:auto;"><table>
          <thead>
            <tr>
              <th>Service date</th>
              <th>RQ#</th>
              <th>Guest</th>
              <th>Type</th>
              <th>Locality</th>
              <th>Supplier</th>
              <th>Harga</th>
            </tr>
          </thead>
          <tbody>`;
        rows.forEach((r) => {
          html += `<tr>
            <td>${r.date}</td>
            <td><span class="rq-pill"><span>RQ</span>${r.rq}</span></td>
            <td>${r.guestName}</td>
            <td><span class="tag small">${r.type}</span></td>
            <td>${r.locality}</td>
            <td>${r.supplier}</td>
            <td>${formatCurrency(r.price)}</td>
          </tr>`;
        });
        html += "</tbody></table></div>";
        todayTableWrapper.innerHTML = html;
      }
    }

    function renderBookingList() {
      if (!bookings.length) {
        bookingListWrapper.innerHTML =
          '<div class="empty-state">Belum ada booking. Tambah data untuk demo CRUD.</div>';
        return;
      }

      let html =
        '<div style="overflow:auto;"><table><thead><tr>' +
        "<th>RQ#</th><th>Guest</th><th>Arrival</th><th>Total service</th><th>Est. pendapatan</th><th>Aksi</th>" +
        "</tr></thead><tbody>";

      bookings.forEach((b) => {
        const revenue = b.services.reduce((acc, s) => acc + (s.price || 0), 0);
        html += `<tr>
          <td><span class="rq-pill"><span>RQ</span>${b.rq}</span></td>
          <td>${b.guestName}</td>
          <td>${b.bookingDate}</td>
          <td>${b.services.length}</td>
          <td>${formatCurrency(revenue)}</td>
          <td>
            <button class="btn-link" data-action="edit" data-id="${b.id}">Edit</button>
            &nbsp;|&nbsp;
            <button class="btn-link danger" data-action="delete" data-id="${b.id}">Hapus</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table></div>";
      bookingListWrapper.innerHTML = html;
    }

    function renderSearchResults(term) {
      const trimmed = (term || "").toLowerCase().trim();
      if (!trimmed) {
        searchResultWrapper.innerHTML =
          '<div class="empty-state">Ketik RQ# atau nama tamu di atas lalu tekan <b>Enter</b>.</div>';
        return;
      }

      const results = bookings.filter(
        (b) =>
          b.rq.toLowerCase().includes(trimmed) ||
          b.guestName.toLowerCase().includes(trimmed)
      );

      if (!results.length) {
        searchResultWrapper.innerHTML = `<div class="empty-state">Tidak ada booking untuk "<b>${term}</b>".</div>`;
        return;
      }

      let html =
        '<div style="overflow:auto;"><table><thead><tr>' +
        "<th>RQ#</th><th>Guest</th><th>Arrival</th><th>Jenis service</th><th>Jumlah service</th><th>Est. pendapatan</th><th>Aksi</th>" +
        "</tr></thead><tbody>";

      results.forEach((b) => {
        const types = Array.from(new Set(b.services.map((s) => s.type))).join(", ");
        const revenue = b.services.reduce((acc, s) => acc + (s.price || 0), 0);
        html += `<tr>
          <td><span class="rq-pill"><span>RQ</span>${b.rq}</span></td>
          <td>${b.guestName}</td>
          <td>${b.bookingDate}</td>
          <td>${types}</td>
          <td>${b.services.length}</td>
          <td>${formatCurrency(revenue)}</td>
          <td>
            <button class="btn-link" data-action="edit" data-id="${b.id}">Edit</button>
            &nbsp;|&nbsp;
            <button class="btn-link danger" data-action="delete" data-id="${b.id}">Hapus</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table></div>";
      searchResultWrapper.innerHTML = html;
    }

    function searchByDateRange(filter) {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();

      const matched = bookings.filter((b) =>
        b.services.some((s) => {
          const d = new Date(s.date);
          if (isNaN(d)) return false;
          if (filter === "today") return s.date === todayStr;
          if (filter === "month")
            return d.getMonth() === thisMonth && d.getFullYear() === thisYear;
          return false;
        })
      );

      if (!matched.length) {
        searchResultWrapper.innerHTML =
          '<div class="empty-state">Belum ada booking untuk filter ini.</div>';
        return;
      }

      let html =
        '<div style="overflow:auto;"><table><thead><tr>' +
        "<th>RQ#</th><th>Guest</th><th>Arrival</th><th>Total service</th><th>Est. pendapatan</th><th>Aksi</th>" +
        "</tr></thead><tbody>";

      matched.forEach((b) => {
        const revenue = b.services.reduce((acc, s) => acc + (s.price || 0), 0);
        html += `<tr>
          <td><span class="rq-pill"><span>RQ</span>${b.rq}</span></td>
          <td>${b.guestName}</td>
          <td>${b.bookingDate}</td>
          <td>${b.services.length}</td>
          <td>${formatCurrency(revenue)}</td>
          <td>
            <button class="btn-link" data-action="edit" data-id="${b.id}">Edit</button>
            &nbsp;|&nbsp;
            <button class="btn-link danger" data-action="delete" data-id="${b.id}">Hapus</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table></div>";
      searchResultWrapper.innerHTML = html;
    }

    // ====== EVENT LISTENERS ======
    btnOpenModal.addEventListener("click", () => openModal());
    btnCloseModal.addEventListener("click", closeModal);
    btnCancelModal.addEventListener("click", closeModal);
    btnAddServiceRow.addEventListener("click", () => addServiceRow());

    bookingForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const rq = generatedRqSpan.textContent;
      const bookingDate = bookingDateInput.value || todayStr;
      const guestName = guestNameInput.value.trim();
      if (!guestName) {
        alert("Nama tamu wajib diisi.");
        return;
      }
      const services = collectServicesFromForm();
      if (!services.length) {
        alert("Minimal satu service.");
        return;
      }

      if (editingBookingId !== null) {
        const idx = bookings.findIndex((b) => b.id === editingBookingId);
        if (idx !== -1) {
          bookings[idx] = {
            id: editingBookingId,
            rq,
            guestName,
            bookingDate,
            services
          };
        }
      } else {
        const id = Date.now(); // simple unique id
        bookings.push({ id, rq, guestName, bookingDate, services });
        bookingCounter += 1;
      }

      closeModal();
      renderDashboard();
      renderBookingList();
      renderSearchResults(searchInput.value);
    });

    searchInput.addEventListener("keyup", (e) => {
      if (e.key === "Enter") {
        renderSearchResults(searchInput.value);
      }
    });

    btnSearchToday.addEventListener("click", () => searchByDateRange("today"));
    btnSearchThisMonth.addEventListener("click", () =>
      searchByDateRange("month")
    );

    chips.forEach((chip) => {
      chip.addEventListener("click", () => {
        chips.forEach((c) => c.classList.remove("active"));
        chip.classList.add("active");
        activeServiceFilter = chip.getAttribute("data-service-filter");
        renderDashboard();
      });
    });

    // event delegation untuk edit/delete di booking list & search result
    function handleTableClick(e) {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;
      const action = btn.getAttribute("data-action");
      const id = Number(btn.getAttribute("data-id"));
      const booking = bookings.find((b) => b.id === id);
      if (!booking) return;

      if (action === "edit") {
        openModal(booking);
      } else if (action === "delete") {
        if (confirm("Hapus booking ini dari data sementara?")) {
          bookings = bookings.filter((b) => b.id !== id);
          renderDashboard();
          renderBookingList();
          renderSearchResults(searchInput.value);
        }
      }
    }

    bookingListWrapper.addEventListener("click", handleTableClick);
    searchResultWrapper.addEventListener("click", handleTableClick);

    // ====== INIT ======
    bookingDateInput.value = todayStr;
    renderDashboard();
    renderBookingList();
  </script>
</body>
</html>
